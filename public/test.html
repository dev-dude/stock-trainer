<html><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Highcharts Demo</title>
  </head>
  <body>
      <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
  <script src="https://momentjs.com/downloads/moment.min.js"></script>

  
  <div id="container" style="height: 500px; min-width: 310px"></div>
  <div style="font-size:12px" id="predictions"></div>
  <div style="font-size:12px" id="allSaves"></div>
  <div style="font-size:12px" id="lastRow"></div>
    <script type="text/javascript">
  
  
  let csvData;
  let allSaves = [];
  let url = new URL(window.location.href);
  let edit = url.searchParams.get("edit") == "true" ? true : false;
  let server = "http://"+window.location.hostname+":8080";

  $.getJSON(server + "/download/" + edit, function (data) {


      csvData = data;
      // Create the chart



    let chart = Highcharts.stockChart('container', {
  
  
          rangeSelector: {
              selected: 1
          },
          yAxis: [{ // Primary yAxis
                labels: {
                    format: 'a',
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                title: {
                    text: '{value}',
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                opposite: true

            }, { 
            gridLineWidth: 0,
            title: {
                text: 'b',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            labels: {
                format: '{value}',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            }
        }

    ],
  
          title: {
              text: ''
          },
          plotOptions: {
                series: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function () {
                                let timestamp = moment.unix(this.category/1000);
                                let backObj = {value:this.y,time:timestamp.utc().format("Y-MM-DD")};
                                $.post(server + '/save', backObj, function(response) {
                                    let responseCopy = Object.assign({}, response);
                                    console.log(responseCopy);
                                    allSaves.unshift(responseCopy);     
                                    let items = "";
                                    let i = 0;
                                    for (;i < allSaves.length; i++) {
                                        console.log(allSaves[i][0]);
                                        let val = parseFloat(allSaves[i].value);
                                        let lastClick =  allSaves[i].isBuy ? "buy" : "sell";
                                        items +=  allSaves[i].data[0] + "-" + parseFloat(allSaves[i].data[4]).toFixed(2) + "- Last Click - " + lastClick + "<br>";
                                    }
                                    let els = "<ul>";
                                    responseCopy.predictions.forEach(function(prediction){
                                        els += "<li> buy: " + prediction.buy + " sell:" +prediction.sell + " hold: " + prediction.hold + " model: " + prediction.type + "</li>";
                                    });
                                    els +="</ul>"
                                    $('#predictions').html(els);
                                    $("#allSaves").html(items);
                                    $('#lastRow').html("<p>"+JSON.stringify(responseCopy.lastRow)+"</p>");
                                }, 'json');
                            }
                        }
                    }
                }
            },
          series: [{
              name: 'ticker',
              yAxis:0,
              data: data.csvData,
              tooltip: {
                  valueDecimals: 2
              }
          },
          {
              name: 'rsi',
              lineWidth:.5,
              yAxis:1,
              dashStyle: 'longdash',
              color: 'grey',
              data: data.rsiData,
              tooltip: {
                  valueDecimals: 2
              }
          }]
      });
        let z = 0;
        for (; z < csvData.buyDataAndDateOnly.length; z++) {
            let plotLine;
            if (csvData.buyDataAndDateOnly[z].action == 1) {
                plotLine = formatPlotLines("b","black",csvData.buyDataAndDateOnly[z].timeStamp);
                chart.xAxis[0].addPlotLine(plotLine);
            } else if (csvData.buyDataAndDateOnly[z].action == -1) {
                plotLine = formatPlotLines("s","red",csvData.buyDataAndDateOnly[z].timeStamp);
                chart.xAxis[0].addPlotLine(plotLine);
            }
            
        }

  });

  function formatPlotLines(type,color,time) {
    let plotLine = {
    value: +time,
        width: .5,
        color: color,
        dashStyle: 'dash',
        label: {
        text: type,
            align: 'left',
            y: 0,
            x: 0
        }
    };
    return plotLine;
}

 
  
  </script>

  
  
  </body></html>